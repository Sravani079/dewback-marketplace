<div class="container mt-5">

  <!-- ðŸŒŸ Catalog Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h1 class="text-center mx-auto text-success fw-bold">
      <i class="bi bi-bookmark-star-fill me-2 text-warning"></i>Dewback Catalog
    </h1>

    <div class="d-flex gap-2">
      <!-- Filter Button -->
      <button class="btn btn-outline-primary" type="button" onclick="toggleFilters()">
        <i class="bi bi-funnel-fill me-1"></i>Filter
      </button>

      <!-- Sort Dropdown -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-sort-down me-1"></i>Sort by
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to "Price: Low to High", catalog_index_path(request.query_parameters.merge(sort_by: "price_asc")), class: "dropdown-item" %></li>
          <li><%= link_to "Price: High to Low", catalog_index_path(request.query_parameters.merge(sort_by: "price_desc")), class: "dropdown-item" %></li>
          <li><%= link_to "Size: Small to Large", catalog_index_path(request.query_parameters.merge(sort_by: "size_asc")), class: "dropdown-item" %></li>
          <li><%= link_to "Size: Large to Small", catalog_index_path(request.query_parameters.merge(sort_by: "size_desc")), class: "dropdown-item" %></li>
          <li><%= link_to "Speed: Slow to Fast", catalog_index_path(request.query_parameters.merge(sort_by: "speed_asc")), class: "dropdown-item" %></li>
          <li><%= link_to "Speed: Fast to Slow", catalog_index_path(request.query_parameters.merge(sort_by: "speed_desc")), class: "dropdown-item" %></li>
        </ul>
      </div>

      <!-- Reset Button -->
      <% if params.slice(:size, :speed, :color, :load, :food, :query).values.any?(&:present?) %>
        <%= link_to raw('<i class="bi bi-arrow-clockwise me-1"></i>Reset'), catalog_index_path, class: "btn btn-outline-info" %>
      <% end %>
    </div>
  </div>

  <!-- ðŸ” Search Bar -->
  <div class="mb-4">
    <%= form_with url: catalog_index_path, method: :get, local: true do %>
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
        <%= text_field_tag :query, params[:query], placeholder: "Search by name or color...", class: "form-control" %>
        <button class="btn btn-outline-secondary" type="submit">Search</button>
      </div>
    <% end %>
  </div>

  <!-- ðŸŽ›ï¸ Filter Panel -->
  <div id="filterPanel" style="display: none;" class="mb-4">
    <%= form_with url: catalog_index_path, method: :get, local: true do %>
      <div class="row g-3">
        <div class="col-md-2">
          <%= label_tag :size, "ðŸ“ Size" %>
          <%= select_tag :size, options_for_select([""] + Dewback::FILTER_OPTIONS[:size], params[:size]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <%= label_tag :speed, "âš¡ Speed" %>
          <%= select_tag :speed, options_for_select([""] + Dewback::FILTER_OPTIONS[:max_speed], params[:speed]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <%= label_tag :color, "ðŸŽ¨ Color" %>
          <%= select_tag :color, options_for_select([""] + Dewback::FILTER_OPTIONS[:color], params[:color]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <%= label_tag :load, "ðŸ“¦ Max Load" %>
          <%= select_tag :load, options_for_select([""] + Dewback::FILTER_OPTIONS[:max_load], params[:load]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <%= label_tag :food, "ðŸ½ï¸ Food Needs" %>
          <%= select_tag :food, options_for_select([""] + Dewback::FILTER_OPTIONS[:food_requirements], params[:food]), class: "form-select" %>
        </div>
        <div class="col-md-2 align-self-end">
          <%= submit_tag raw('<i class="bi bi-check2-circle me-1"></i>Apply'), class: "btn btn-primary w-100" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- ðŸ‰ Dewback Cards -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% @dewbacks.each do |dewback| %>
      <div class="col">
        <div class="card h-100 shadow-sm position-relative">

          <% if dewback.on_sale && dewback.discounted_price.present? && dewback.discounted_price < dewback.price %>
            <div class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 fw-bold">SALE</div>
          <% end %>

          <div class="d-flex justify-content-center align-items-center" style="height: 250px; overflow: hidden;">
            <% if dewback.image_file.attached? %>
              <%= image_tag url_for(dewback.image_file), class: "img-fluid", style: "max-height: 100%; object-fit: contain;" %>
            <% elsif dewback.image.present? %>
              <%= image_tag asset_path(dewback.image), class: "img-fluid", style: "max-height: 100%; object-fit: contain;" %>
            <% else %>
              <%= image_tag "placeholder.png", class: "img-fluid", style: "max-height: 100%; object-fit: contain;" %>
            <% end %>
          </div>

          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-center">
              <%= link_to dewback.title, dewback_path(dewback), class: "text-decoration-none" %>
            </h5>

            <ul class="list-unstyled mb-3">
              <% if dewback.on_sale && dewback.discounted_price.present? && dewback.discounted_price < dewback.price %>
                <li>
                  <strong>Price:</strong>
                  <span class="text-danger fw-bold">$<%= dewback.discounted_price %></span>
                  <span class="text-muted text-decoration-line-through">$<%= dewback.price %></span>
                </li>
              <% else %>
                <li><strong>Price:</strong> $<%= dewback.price %></li>
              <% end %>
              <li><strong>Size:</strong> <%= dewback.size.capitalize %></li>
              <li><strong>Load:</strong> <%= dewback.max_load.capitalize %></li>
              <li><strong>Speed:</strong> <%= dewback.max_speed.capitalize %></li>
              <li><strong>Food:</strong> <%= dewback.food_requirements.capitalize %></li>
            </ul>

            <p class="card-text mt-auto"><%= truncate(dewback.description, length: 100) %></p>

            <% if current_user&.admin? %>
              <div class="mt-3 text-center">
                <%= link_to "Edit", edit_admin_dewback_path(dewback), class: "btn btn-warning btn-sm" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

</div>

<!-- JavaScript: Toggle Filter Panel -->
<script>
  function toggleFilters() {
    const panel = document.getElementById('filterPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }
</script>
